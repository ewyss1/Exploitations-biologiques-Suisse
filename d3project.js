// création variables
var data_csv = [];

var width = 960;
var height = 500;

var cantons;
var year = 1999;
// total, cereales, graines, autres
var dataType = "total";
//var boutonTotal = d3.select("#boutonTotal").node();

var slider = document.getElementById("slider");



//var cantonsID = ["AG","AI","AR","BE","BL","BS","FR","GE","GL","GR","JU","LU","NE","NW","OW","SG","SH","SO","SZ","TG","TI","UR","VD","VS","ZG","ZH"];

// CHANGER DE COULEUR UN CANTON EX: ZH
// d3.select("#ZH").attr("fill","blue");

//fonction d'initialisation du script
function init() {
    initMap();
    importData();
};

// Importation des données du CSV
function importData(){

    // obtenir les données et les ranger dans un tableau
    d3.csv("data_clean.csv", function(d){
        return {
            annee: d.annee,
            id: d.id,
            canton: d.canton,
            total: d.total_arr,
            cereales: d.cereales_arr,
            graines: d.graines_arr,
            autres: d.autres_arr
        }; 
    })
    .then(function(data) {

        // parcourir les données lues et les reclasser dans un array
        for (var i = 0; i<data.length; i++){
            if (data_csv[data[i].annee] === undefined)  {
                data_csv[data[i].annee] = [];
            }
            data_csv[data[i].annee].push({id:data[i].id,canton:data[i].canton,total:Number(data[i].total),cereales:Number(data[i].cereales),graines:Number(data[i].graines),autres:Number(data[i].autres)});
            
            /*if (data_csv[data[i].annee][data[i].id] === undefined){
                data_csv[data[i].annee][data[i].id] = [];
            }*/
            /*data_csv[data[i].annee]["id"] = data[i].id;
            data_csv[data[i].annee]["total"] = data[i].total;
            data_csv[data[i].annee]["cereales"] = data[i].cereales;
            data_csv[data[i].annee]["graines"] = data[i].graines;
            data_csv[data[i].annee]["autres"] = data[i].autres;*/
        }

        setUpHeatMap(year, dataType);
        bindButtons();
        initButtons();
    })
    .catch(function (e){
        return false;
    });

    // contrôler les Arrays
    console.log(data_csv);
}

function initMap(){

    //Utilisation de Albers qui est une projection conique
    var projection = d3.geoAlbers()
        .rotate([0, 0])
        .center([8.3, 46.8])
        .scale(14000)
        .translate([width / 2, height / 2])
        .precision(.1);

    //définition du chemin géographique
    var path = d3.geoPath()
        .projection(projection);

    // création de la balise contenant la carte
    var svgMap = d3.select("#map").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("id","svgMap");

    //avec les données de la Suisse: création du contour et des limites des cantons
    d3.json("swiss.json")
        .then(function(swiss) {

            cantons = topojson.feature(swiss, swiss.objects.cantons);

            // création des cantons
            svgMap.selectAll(".canton").data(cantons.features)
                .enter().append("path")
                .attr("fill", "none")
                .attr("id", function(d) { return d.id; })
                .attr("data-canton", function(e) { return e.properties.name; })
                .attr("class", "cantonsPath")
                .attr("d", path);
                //.on("mouseover", mouseOver);
    }) 
    .catch(function (e){
        return false;
    });
}

function mouseOver(){
    this.style.stroke = "#aaa";
    this.style["stroke-width"] = 2;
    // accéder à l'élément data-canton
    d3.select("#nomCanton").html(d3.select(this).attr("data-canton"));
    d3.select("#donneeCanton").html(d3.select(this).attr("data-data")+" ha de surfaces d'exploitations biologiques"); 
    //console.log(this);
    this.parentNode.appendChild(this);
}

function mouseOut(){
    this.style.stroke = "#000";
    this.style["stroke-width"] = 1.5;

}

// coloration des cantons selon les données et les paramètres (y = année sélectionnée (défaut:1999) dt = type de données (défaut:total))
function setUpHeatMap(y, dt){
    // récupération de la valeur maximale pour l'année y et le type de données dt
    var maxValue = getMaxValue(y, dt);
    var minValue = getMinValue(y, dt,maxValue);
    d3.select("#minValue").html(minValue + " ha");
    d3.select("#maxValue").html(maxValue + " ha");
    if (maxValue!=0){
        for (var i=0; i<data_csv[y].length; i++){
            var dataCanton = data_csv[y][i][dt];
            var idCanton = data_csv[y][i]["id"];
            var pourcentage = ((dataCanton-minValue)*100)/(maxValue-minValue);
            //var r = Math.round((-1.61)*pourcentage+255);
            //var r = Math.round((-2.55)*pourcentage+255);
            var g = (pourcentage < 50) ? Math.round((2.55)*(pourcentage*2)) : 255;
            //var g = 255;
            var r= (pourcentage <= 50) ? 255 : Math.round(255+(-2.55)*(pourcentage-50)*2);
            //var b = Math.round((-0.27)*pourcentage+126);
            var b = 0;
            //console.log(idCanton+": "+"rgb("+r+", "+g+" ,"+b+") - " + pourcentage);
            d3.select("#"+idCanton).attr("fill","rgb("+r+", "+g+" ,"+b+")").attr("data-data", dataCanton)
                .on("mouseover", mouseOver).on("mouseout", mouseOut);
        }
    }
    else{
        d3.selectAll(".cantonsPath").attr("fill","rgb(100,100,100)").attr("data-data", "Pas de données pour le nombre");
    }
};

// renvoie la valeur maximale de l'année y et du type de données dt
function getMaxValue(y, dt){

    //console.log(y +" "+ dataType);
    var max = 0;
    for (var i=0;i<data_csv[y].length;i++){
        if(data_csv[y][i][dt]>max){
            //console.log("Max:"+max+" data:"+data_csv[y][i][dt]);
            max=data_csv[y][i][dt];
        }
    };
    return max;
};

function getMinValue(y, dt, max){

    //console.log(y +" "+ dataType);
    var min = max;
    for (var i=0;i<data_csv[y].length;i++){
        if(data_csv[y][i][dt]<min){
            min=data_csv[y][i][dt];
        }
    };
    return min;
};

//créer la fonction liée à la barre de défilement

//mettre la valeur par défaut
slider.value = year;


function bindButtons(){
    d3.selectAll(".dataTypeBtn").on("click",function(){
        dataType = d3.select(this).attr("value");
        d3.select(".clickedBtn").attr("class", "dataTypeBtn");
        d3.select(this).attr("class", "dataTypeBtn clickedBtn");
        setUpHeatMap(year,dataType);
        d3.select("#donneeCanton").html("");
        d3.select("#nomCanton").html("");
    });
    //actualiser à chaque mouvement de barre
    d3.select("#slider").on("click",function() {
        //year = d3.select(this).attr("value");
        year = slider.value;
        d3.select("#sliderLabel").html(year);
        setUpHeatMap(year,dataType);
        d3.select("#donneeCanton").html("");
        d3.select("#nomCanton").html("");
    });
}

function initButtons(){
    d3.select(".dataTypeBtn[value="+dataType+"]").attr("class","dataTypeBtn clickedBtn");
}



// lancement du script
init();